<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RKV 2025 â€“ Chat</title>
  <style>
    *{box-sizing:border-box}html,body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    /* Flydende launcher */
    .launcher{position:fixed;right:16px;bottom:16px;width:56px;height:56px;border-radius:999px;border:0;background:#e30613;color:#fff;
      box-shadow:0 6px 20px rgba(0,0,0,.2);font-size:22px;cursor:pointer}
    .panel{position:fixed;right:16px;bottom:84px;width:360px;max-width:95vw;height:70vh;max-height:80vh;background:#fff;border:1px solid #e5e7eb;
      border-radius:16px;box-shadow:0 12px 30px rgba(0,0,0,.2);display:none;flex-direction:column;overflow:hidden}
    .panel.open{display:flex}
    .topbar{background:#e30613;color:#fff;padding:10px 12px;display:flex;align-items:center;gap:8px}
    .brand{font-weight:800}
    .hero{padding:10px 12px;border-bottom:1px solid #f1f5f9}
    .hero .logo{width:36px;height:36px;border-radius:999px;background:#ffe066;display:inline-grid;place-items:center;margin-right:6px}
    .suggest{display:grid;grid-template-columns:1fr;gap:8px;margin-top:8px}
    .suggest button{border:1px solid #e5e7eb;background:#fff;border-radius:12px;padding:8px 10px;text-align:left;cursor:pointer}
    .chat{flex:1;overflow:auto;padding:10px 12px;background:#fff}
    .msg{display:flex;gap:8px;margin:6px 0}
    .msg.user{justify-content:flex-end}
    .msg .bubble{max-width:80%;padding:10px;border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.06)}
    .msg.user .bubble{background:#0f172a;color:#fff}
    .msg.assistant .bubble{background:#f8fafc;border:1px solid #e5e7eb}
    .sources{margin-top:6px;padding-top:6px;border-top:1px solid #e2e8f0}
    .sources-title{font-size:10px;letter-spacing:.04em;color:#64748b;text-transform:uppercase;margin-bottom:4px}
    .composer{border-top:1px solid #e5e7eb;padding:8px;background:#fff}
    .composer .row{display:flex;gap:8px}
    .composer textarea{flex:1;border:1px solid #e5e7eb;border-radius:999px;padding:10px 12px;resize:none;height:42px}
    .composer button{width:56px;border-radius:999px;border:0;background:#0f172a;color:#fff;font-size:18px;cursor:pointer}
    .foot{font-size:11px;color:#64748b;text-align:center;margin-top:6px}
    .config{position:fixed;left:16px;bottom:16px;background:#0f172a;color:#fff;font-size:12px;padding:6px 10px;border-radius:999px;opacity:.9}
    .config input{width:260px;border:0;border-radius:8px;padding:6px 8px;margin-left:6px}
  </style>
</head>
<body>
  <!-- Flydende knap -->
  <button class="launcher" id="launcher" title="Ã…bn chat">ðŸ’¬</button>

  <!-- Chatpanel -->
  <div class="panel" id="panel">
    <div class="topbar"><span class="brand">RKV</span><span>Hej-chat</span>
      <button id="close" title="Luk" style="margin-left:auto;background:transparent;border:0;color:#fff;font-size:18px;cursor:pointer">âœ•</button>
    </div>

    <div class="hero">
      <div><span class="logo">ðŸ™‚</span><strong>Hej RKV 2025</strong></div>
      <div style="color:#475569;font-size:14px;margin-top:4px">Stil spÃ¸rgsmÃ¥l om RKVâ€™s journalistik. Svarene kan komme fra din backend eller demo-mode.</div>
      <div class="suggest" id="suggest"></div>
    </div>

    <div class="chat" id="chat"></div>

    <div class="composer">
      <div class="row">
        <textarea id="input" placeholder="Skriv dit spÃ¸rgsmÃ¥l her"></textarea>
        <button id="send" title="Send">âž¤</button>
      </div>
      <div class="foot">Tip: tryk Enter for at sende</div>
    </div>
  </div>

  <!-- Lille config til API-URL -->
  <div class="config">API:
    <input id="apiUrl" placeholder="https://din-backend.dk/api/ask" />
  </div>

  <script>
    // ----- UI elementer -----
    const panel = document.getElementById('panel');
    const launcher = document.getElementById('launcher');
    const closeBtn = document.getElementById('close');
    const chatEl = document.getElementById('chat');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    const suggestEl = document.getElementById('suggest');
    const apiUrlEl = document.getElementById('apiUrl');

    // ----- Launcher -----
    launcher.onclick = () => panel.classList.add('open');
    closeBtn.onclick = () => panel.classList.remove('open');

    // ----- Demo-forslag -----
    const DEFAULT_SUGGESTED = [
      { t: "Hvordan stemmer jeg til valget?", e: "ðŸ—³ï¸" },
      { t: "Hvad er status pÃ¥ kommunens budget?", e: "ðŸ›ï¸" },
      { t: "Hvad betyder Ã¦ndringerne i dagpengene?", e: "ðŸ’¬" }
    ];
    DEFAULT_SUGGESTED.forEach(s => {
      const b = document.createElement('button');
      b.innerHTML = `<span style="margin-right:6px">${s.e}</span>${s.t}`;
      b.onclick = () => ask(s.t);
      suggestEl.appendChild(b);
    });

    // ----- Session-id til evt. logging i backend -----
    const SESSION_KEY = "rkv_session_id";
    let SESSION_ID = localStorage.getItem(SESSION_KEY);
    if (!SESSION_ID) { SESSION_ID = crypto.randomUUID(); localStorage.setItem(SESSION_KEY, SESSION_ID); }

    // ----- API URL (gemmes i localStorage) -----
    let API_URL = localStorage.getItem('rkv_api_url') || "";
    apiUrlEl.value = API_URL;
    apiUrlEl.onchange = () => {
      API_URL = apiUrlEl.value.trim();
      if (API_URL) localStorage.setItem('rkv_api_url', API_URL);
      else localStorage.removeItem('rkv_api_url');
    };

    // ----- HjÃ¦lpere -----
    function sanitize(q){ return (q||"").replace(/\s+/g," ").trim(); }
    function addMessage(role, text, sources){
      const wrap = document.createElement('div');
      wrap.className = 'msg ' + (role === 'user' ? 'user' : 'assistant');
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.textContent = text;
      wrap.appendChild(bubble);

      if (sources?.length){
        const sct = document.createElement('div'); sct.className='sources';
        const ttl = document.createElement('div'); ttl.className='sources-title'; ttl.textContent='Kilder';
        sct.appendChild(ttl);
        const ul = document.createElement('ul');
        sources.forEach(s=>{
          const li=document.createElement('li');
          li.innerHTML = `<div style="font-weight:600;font-size:12px">${s.title||"Kilde"}</div>
                          ${s.snippet?`<div style="color:#64748b;font-size:12px">${s.snippet}</div>`:''}
                          ${s.url?`<a style="font-size:12px" target="_blank" rel="noreferrer" href="${s.url}">${s.url}</a>`:''}`;
          ul.appendChild(li);
        });
        sct.appendChild(ul);
        bubble.appendChild(sct);
      }

      chatEl.appendChild(wrap);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    async function ask(q){
      const query = sanitize(q || inputEl.value);
      if (!query) return;
      addMessage('user', query);
      inputEl.value = '';

      try{
        if (!API_URL){
          // Demo-mode
          await new Promise(r=>setTimeout(r,400));
          addMessage('assistant', `(Demo) Du spurgte: "${query}". SÃ¦t din API-URL nederst til venstre for rigtige svar.`, [
            { title:"Demo-kilde", url:"https://example.com", snippet:"Dette er en demo." }
          ]);
          return;
        }

        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type':'application/json', 'X-Client-Session': SESSION_ID },
          body: JSON.stringify({ query, topK: 5, model: 'gpt-4o' })
        });
        if (!res.ok) throw new Error('API-fejl: ' + res.status);
        const data = await res.json();
        addMessage('assistant', data.answer || '(Tomt svar)', data.sources || []);
      }catch(e){
        addMessage('assistant', 'Der skete en fejl: ' + (e?.message||e));
      }
    }

    // ----- SendhÃ¥ndtering -----
    sendBtn.onclick = ()=>ask();
    inputEl.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter' && !e.shiftKey){
        e.preventDefault();
        ask();
      }
    });
  </script>
</body>
</html>
